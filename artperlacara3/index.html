<!DOCTYPE html>
<html lang="ca">
<!-- L'atribut "lang" especifica que el contingut estÃ  en catalÃ  -->

<head>
Â  <meta charset="UTF-8">
Â  <!-- Defineix la codificaciÃ³ de carÃ cters com UTF-8, assegurant la correcta visualitzaciÃ³ de tots els sÃ­mbols -->

Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <!-- Defineix el viewport perquÃ¨ la pÃ gina s'adapti a dispositius mÃ²bils:
Â  Â  Â  Â - width=device-width: l'amplada coincideix amb la de l'aparell
Â  Â  Â  Â - initial-scale=1.0: escala inicial de 100% -->

Â  <title>Art Facial Responsiu - Transicions Suaus i Fons DinÃ mic</title>
Â  <!-- Estableix el tÃ­tol de la pÃ gina, que apareixerÃ  a la pestanya del navegador -->

Â  <!-- Carrega la biblioteca p5.js per al dibuix interactiu i la gestiÃ³ del canvas -->
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
Â  <!-- Carrega la biblioteca ml5.js, que contÃ© models de machine learning com la detecciÃ³ facial -->
Â  <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
Â  <!-- Aquest script carrega ml5.js en una versiÃ³ compilada, utilitzada per la detecciÃ³ facial -->

Â  <style>
Â  Â  /*--------------------------------------------------
Â  Â  Â  ESTILS PER A TOTA LA PÃ€GINA
Â  Â  Â  --------------------------------------------------*/
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  overflow: hidden;
Â  Â  Â  background: #f0f0f0;
Â  Â  }
Â  Â  /*--------------------------------------------------
Â  Â  Â  ESTILS PER A LA PANTALLA DE CÃ€RREGA (LOADING SCREEN)
Â  Â  Â  --------------------------------------------------*/
Â  Â  #loading-screen {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(255,255,255,0.95);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  z-index: 1000;
Â  Â  }
Â  Â  /*--------------------------------------------------
Â  Â  Â  ESTILS PER AL CERCLE GIRATORI (LOADER)
Â  Â  Â  --------------------------------------------------*/
Â  Â  .loader {
Â  Â  Â  width: 40px;
Â  Â  Â  height: 40px;
Â  Â  Â  border: 5px solid #3498db;
Â  Â  Â  border-top-color: transparent;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  }
Â  Â  /*--------------------------------------------------
Â  Â  Â  ANIMACIÃ“ PER GIRAR EL CERCLE
Â  Â  Â  --------------------------------------------------*/
Â  Â  @keyframes spin {
Â  Â  Â  to { transform: rotate(360deg); }
Â  Â  }
Â  Â  /*--------------------------------------------------
Â  Â  Â  ESTILS PER ALS PARÃ€GRAFS DINS DEL LOADING SCREEN
Â  Â  Â  --------------------------------------------------*/
Â  Â  #loading-screen p {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  color: #333;
Â  Â  }
Â  </style>
</head>
<body>
Â  <!--
Â  Â  Contingut visible de la pÃ gina. AquÃ­ mostrarem primer la pantalla de cÃ rrega,
Â  Â  que desprÃ©s s'amagarÃ  quan es carreguin els models.
Â  -->
Â  <div id="loading-screen">
Â  Â  <!-- Aquest element contÃ© el cercle giratori -->
Â  Â  <div class="loader"></div>
Â  Â  <!-- I un missatge per informar a l'usuari que es carreguen els models -->
Â  Â  <p>Carregant models...</p>
Â  </div>
Â  <script>
Â  Â  // VARIABLES GLOBALES
Â  Â  let faceapi, detections = [], video;
Â  Â  // "faceapi" serÃ  l'objecte que ens gestionarÃ  la detecciÃ³ facial.
Â  Â  // "detections" Ã©s una matriu (array) que emmagatzemarÃ  les deteccions facials.
Â  Â  // "video" guardarÃ  el flux de vÃ­deo capturat des de la cÃ mera.
Â  Â  
Â  Â  let modelsReady = false;
Â  Â  // Variable booleana que indicarÃ  si els models han estat carregats correctament (comenÃ§a en false).
Â  Â  let currentExpression = { dominant: 'neutral', intensity: 0 };
Â  Â  // Objecte que emmagatzema l'expressiÃ³ facial actual:
Â  Â  // "dominant" indica l'expressiÃ³ mÃ©s marcada (inicialment "neutral")
Â  Â  // "intensity" indica la intensitat de l'expressiÃ³ (valors entre 0 i 1).

Â  Â  // Variable per a una transiciÃ³ suau de la intensitat detectada
Â  Â  let smoothIntensity = 0;
Â  Â  // AixÃ² permet interpolar suaument entre l'estat anterior i el nou.

Â  Â  // VARIABLES PER AL FONS â€“ GRADIENT DINÃ€MIC
Â  Â  let currentGradientStart, currentGradientEnd;
Â  Â  // Colors actius per al gradient actual del fons.

Â  Â  let targetGradientStart, targetGradientEnd;
Â  Â  // Colors objectiu per al gradient, segons lâ€™emociÃ³ detectada; s'interpolaran fins aconseguir la transiciÃ³ suau.

Â  Â  // FUNCIÃ“ PER OBTINDRE ELS COLORS DEL GRADIENT
Â  Â  function getGradientForEmotion(emotion) {
Â  Â  Â  // Aquesta funciÃ³ rep com a parÃ metre l'emociÃ³ i retorna un objecte amb dos colors: start i end.
Â  Â  Â  switch (emotion) {
Â  Â  Â  Â  case 'happy':
Â  Â  Â  Â  Â  return { start: color(255, 223, 186), end: color(255, 183, 77) };
Â  Â  Â  Â  case 'sad':
Â  Â  Â  Â  Â  return { start: color(173, 216, 230), end: color(100, 149, 237) };
Â  Â  Â  Â  case 'angry':
Â  Â  Â  Â  Â  return { start: color(255, 160, 122), end: color(255, 69, 0) };
Â  Â  Â  Â  case 'disgusted':
Â  Â  Â  Â  Â  return { start: color(144, 238, 144), end: color(34, 139, 34) };
Â  Â  Â  Â  case 'surprised':
Â  Â  Â  Â  Â  return { start: color(216, 191, 216), end: color(147, 112, 219) };
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  return { start: color(240, 240, 240), end: color(200, 200, 200) };
Â  Â  Â  }
Â  Â  }

Â  Â  // FUNCIÃ“ PER DIBUIXAR UN GRADIENT VERTICAL
Â  Â  function setGradient(x, y, w, h, c1, c2, axis = 'y') {
Â  Â  Â  // Aquesta funciÃ³ pinta un gradient dins d'un rectangle definit per la posiciÃ³ (x,y) i dimensions (w, h).
Â  Â  Â  // "c1" i "c2" sÃ³n els colors inicial i final.
Â  Â  Â  // "axis" indica si el gradient Ã©s vertical ('y') o horitzontal ('x'); per defecte Ã©s vertical.
Â  Â  Â  noFill();
Â  Â  Â  if (axis === 'y') {
Â  Â  Â  Â  for (let i = y; i <= y + h; i++) {
Â  Â  Â  Â  Â  let inter = map(i, y, y + h, 0, 1);
Â  Â  Â  Â  Â  let c = lerpColor(c1, c2, inter);
Â  Â  Â  Â  Â  stroke(c);
Â  Â  Â  Â  Â  line(x, i, x + w, i);
Â  Â  Â  Â  }
Â  Â  Â  } else if (axis === 'x') {
Â  Â  Â  Â  for (let i = x; i <= x + w; i++) {
Â  Â  Â  Â  Â  let inter = map(i, x, x + w, 0, 1);
Â  Â  Â  Â  Â  let c = lerpColor(c1, c2, inter);
Â  Â  Â  Â  Â  stroke(c);
Â  Â  Â  Â  Â  line(i, y, i, y + h);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // FUNCIÃ“ SETUP (p5.js)
Â  Â  function setup() {
Â  Â  Â  // Aquesta funciÃ³ s'executa una sola vegada quan la pÃ gina es carrega.
Â  Â  Â  createCanvas(windowWidth, windowHeight);
Â  Â  Â  // Crea el canvas de p5.js amb l'amplada i alÃ§ada iguals a la finestra.

Â  Â  Â  // Establim el gradient inicial segons l'emociÃ³ "neutral"
Â  Â  Â  let neutralGrad = getGradientForEmotion('neutral');
Â  Â  Â  currentGradientStart = neutralGrad.start;
Â  Â  Â  currentGradientEnd = neutralGrad.end;

Â  Â  Â  // CONFIGURACIÃ“ DEL VÃDEO:
Â  Â  Â  video = createCapture(VIDEO);
Â  Â  Â  video.size(320, 240);
Â  Â  Â  video.hide();
Â  Â  Â  video.elt.muted = true;
Â  Â  Â  video.elt.playsinline = true;

Â  Â  Â  // OPCIONS PER AL MODEL FACIAL:
Â  Â  Â  const options = {
Â  Â  Â  Â  withLandmarks: true,
Â  Â  Â  Â  withExpressions: true,
Â  Â  Â  Â  withDescriptors: false
Â  Â  Â  };

Â  Â  Â  // INICIALITZACIÃ“ DE faceapi
Â  Â  Â  faceapi = ml5.faceApi(video, options, () => {
Â  Â  Â  Â  // Aquesta funciÃ³ callback s'executa quan el model ha estat carregat correctament.
Â  Â  Â  Â  modelsReady = true; Â // Marquem que els models estan preparats.
Â  Â  Â  Â  // Amaguem la pantalla de cÃ rrega perquÃ¨ el model ja estÃ  llest.
Â  Â  Â  Â  document.getElementById('loading-screen').style.display = 'none';
Â  Â  Â  Â  // Inicia la detecciÃ³ facial, passant la funciÃ³ gotResults com a callback per rebre resultats.
Â  Â  Â  Â  faceapi.detect(gotResults);
Â  Â  Â  });
Â  Â  }

Â  Â  // FUNCIÃ“ windowResized (p5.js)
Â  Â  function windowResized() {
Â  Â  Â  // Aquesta funciÃ³ s'executa cada cop que la finestra redimensiona.
Â  Â  Â  resizeCanvas(windowWidth, windowHeight);
Â  Â  Â  // Ajusta el canvas a la nova mida de la finestra.
Â  Â  Â  video.size(max(160, width / 4), max(120, height / 4));
Â  Â  Â  // TambÃ© redimensiona la cÃ mera, assegurant un mÃ­nim perquÃ¨ el vÃ­deo no es faci massa petit.
Â  Â  }

Â  Â  // FUNCIÃ“ gotResults - Callback de detecciÃ³ facial
Â  Â  function gotResults(err, results) {
Â  Â  Â  // Aquesta funciÃ³ s'executa cada cop que ml5.faceApi retorna resultats.
Â  Â  Â  if (err) {
Â  Â  Â  Â  // En cas d'error, imprimeix-lo a la consola.
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  // Mostra un missatge d'error en la pantalla de cÃ rrega indicant un problema amb la cÃ mera.
Â  Â  Â  Â  document.getElementById('loading-screen').innerHTML =
Â  Â  Â  Â  Â  '<p style="color: red">Error! Comprova la cÃ mera i actualitza.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // Guarda les deteccions en la variable global "detections".
Â  Â  Â  detections = results;
Â  Â  Â  // Si hi ha deteccions (almenys una cara detectada), actualitza l'expressiÃ³ actual.
Â  Â  Â  if (detections.length > 0) updateCurrentExpression();
Â  Â  Â  // Torna a cridar la detecciÃ³ facial per obtenir resultats contÃ­nus.
Â  Â  Â  faceapi.detect(gotResults);
Â  Â  }

Â  Â  // FUNCIÃ“ updateCurrentExpression
Â  Â  function updateCurrentExpression() {
Â  Â  Â  // Aquesta funciÃ³ recorre totes les deteccions facials i actualitza l'expressiÃ³ dominant.
Â  Â  Â  let maxIntensity = 0;
Â  Â  Â  detections.forEach(face => {
Â  Â  Â  Â  const expr = face.expressions;
Â  Â  Â  Â  const dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
Â  Â  Â  Â  if (expr[dominant] > maxIntensity) {
Â  Â  Â  Â  Â  currentExpression = {
Â  Â  Â  Â  Â  Â  dominant: dominant,
Â  Â  Â  Â  Â  Â  intensity: expr[dominant]
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  maxIntensity = expr[dominant];
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // Actualitza els colors del gradient objectiu segons l'emociÃ³ dominant detectada.
Â  Â  Â  let grad = getGradientForEmotion(currentExpression.dominant);
Â  Â  Â  targetGradientStart = grad.start;
Â  Â  Â  targetGradientEnd = grad.end;
Â  Â  }

Â  Â  function scaleFactor() {
Â  Â  Â  // Ajusta 800 si els dibuixos estan basats en coordenades de 800x800
Â  Â  Â  return Math.min(width, height) / 800;
Â  Â  }

Â  Â  // FUNCIÃ“ draw (p5.js)
Â  Â  function draw() {
Â  Â  Â  // Aquesta funciÃ³ s'executa constantment (frame per frame) per actualitzar el dibuix.
Â  Â  Â  // InterpolaciÃ³ suau de l'intensitat: actualitza smoothIntensity per aconseguir una transiciÃ³ fluida.
Â  Â  Â  smoothIntensity = lerp(smoothIntensity, currentExpression.intensity, 0.1);

Â  Â  Â  // ActualitzaciÃ³ suau dels colors del gradient:
Â  Â  Â  if (targetGradientStart && targetGradientEnd) {
Â  Â  Â  Â  currentGradientStart = lerpColor(currentGradientStart, targetGradientStart, 0.1);
Â  Â  Â  Â  currentGradientEnd = lerpColor(currentGradientEnd, targetGradientEnd, 0.1);
Â  Â  Â  }

Â  Â  Â  // Dibuixa el fons dinÃ mic pintant un gradient vertical que cobreix tot el canvas.
Â  Â  Â  setGradient(0, 0, width, height, currentGradientStart, currentGradientEnd, 'y');

Â  Â  Â  // Dibuixa l'art interactiu al centre del canvas:
Â  Â  Â  push();
Â  Â  Â  translate(width / 2, height / 2);
Â  Â  Â  scale(scaleFactor());
Â  Â  Â  drawArt();
Â  Â  Â  pop();

Â  Â  Â  // Dibuixa la interfÃ­cie (HUD) amb informaciÃ³ textual (emoticon i percentatge).
Â  Â  Â  drawHUD();
Â  Â  Â  // Dibuixa una previsualitzaciÃ³ petita del vÃ­deo en una cantonada.
Â  Â  Â  drawVideoPreview();
Â  Â  }

Â  Â  // FUNCIÃ“ drawArt
Â  Â  function drawArt() {
Â  Â  Â  // Aquesta funciÃ³ dibuixa formes artÃ­stiques basades en l'expressiÃ³ facial detectada.
Â  Â  Â  const { dominant, intensity } = currentExpression;
Â  Â  Â  strokeWeight(map(smoothIntensity, 0, 1, 1, 4));
Â  Â  Â  noFill();

Â  Â  Â  // Utilitza un "switch" per determinar quina forma dibuixar segons l'expressiÃ³ dominant.
Â  Â  Â  switch (dominant) {
Â  Â  Â  Â  case 'happy':
Â  Â  Â  Â  Â  // Cara rodona, boca somrient, galtes vermelles, celles altes
Â  Â  Â  Â  Â  stroke(0, 200, 0, 150);
Â  Â  Â  Â  Â  fill(255, 255, 180 + intensity * 75); // cara cÃ lida
Â  Â  Â  Â  Â  ellipse(0, 0, 400, 400);

Â  Â  Â  Â  Â  // Ulls: arcs somrients
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5);
Â  Â  Â  Â  Â  arc(-80, -30, 50, 30, 0, PI);
Â  Â  Â  Â  Â  arc(80, -30, 50, 30, 0, PI);

Â  Â  Â  Â  Â  // Celles altes i corbes
Â  Â  Â  Â  Â  stroke(80, 50, 0);
Â  Â  Â  Â  Â  strokeWeight(6);
Â  Â  Â  Â  Â  arc(-80, -70 - intensity * 10, 70, 30 + intensity * 15, PI, TWO_PI);
Â  Â  Â  Â  Â  arc(80, -70 - intensity * 10, 70, 30 + intensity * 15, PI, TWO_PI);

Â  Â  Â  Â  Â  // Galtes vermelles per intensitat
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  fill(255, 180, 180, 100*intensity);
Â  Â  Â  Â  Â  ellipse(-70, 40, 40+intensity*25, 20+intensity*10);
Â  Â  Â  Â  Â  ellipse(70, 40, 40+intensity*25, 20+intensity*10);

Â  Â  Â  Â  Â  // Boca gran, mÃ©s ampla amb intensitat
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5 + intensity * 3);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-80, 100);
Â  Â  Â  Â  Â  bezierVertex(-20, 140 + intensity*40, 20, 140 + intensity*40, 80, 100);
Â  Â  Â  Â  Â  endShape();
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'sad':
Â  Â  Â  Â  Â  // Cara blava, boca trista, celles inclinades, llÃ grimes
Â  Â  Â  Â  Â  stroke(0, 0, 150, 150);
Â  Â  Â  Â  Â  fill(150, 150, 255, 200);
Â  Â  Â  Â  Â  ellipse(0, 0, 400, 400);

Â  Â  Â  Â  Â  // Ulls: arcs cap avall
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5);
Â  Â  Â  Â  Â  arc(-80, -30, 50, 30, PI, 0);
Â  Â  Â  Â  Â  arc(80, -30, 50, 30, PI, 0);

Â  Â  Â  Â  Â  // Celles: inclinades cap al centre
Â  Â  Â  Â  Â  stroke(80,50,0);
Â  Â  Â  Â  Â  strokeWeight(6);
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-110, -80);
Â  Â  Â  Â  Â  vertex(-70, -90 - intensity*18);
Â  Â  Â  Â  Â  endShape();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(70, -90 - intensity*18);
Â  Â  Â  Â  Â  vertex(110, -80);
Â  Â  Â  Â  Â  endShape();

Â  Â  Â  Â  Â  // LlÃ grimes, mÃ©s amb mÃ©s intensitat
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  fill(0, 100, 255, 140+intensity*100);
Â  Â  Â  Â  Â  ellipse(-80, 10, 10, 20+intensity*10);
Â  Â  Â  Â  Â  ellipse(80, 10, 10, 20+intensity*10);
Â  Â  Â  Â  Â  if (intensity > 0.5) {
Â  Â  Â  Â  Â  Â  ellipse(-80, 40, 8, 16+intensity*8);
Â  Â  Â  Â  Â  Â  ellipse(80, 40, 8, 16+intensity*8);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Boca molt trista
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5 + intensity*3);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-80, 100);
Â  Â  Â  Â  Â  bezierVertex(-20, 60-intensity*30, 20, 60-intensity*30, 80, 100);
Â  Â  Â  Â  Â  endShape();
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'angry':
Â  Â  Â  Â  Â  // Cara quadrada, vermella, boca enfadada, celles molt inclinades, galtes vermelles
Â  Â  Â  Â  Â  stroke(200, 0, 0, 150);
Â  Â  Â  Â  Â  fill(255, 50+intensity*80, 50+intensity*40, 220);
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-200,-200); vertex(200,-200); vertex(200,200); vertex(-200,200); vertex(-200,-200);
Â  Â  Â  Â  Â  endShape(CLOSE);

Â  Â  Â  Â  Â  // Ulls estrets i quadrats
Â  Â  Â  Â  Â  fill(0);
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  rect(-150, -80, 60, 60 - intensity*20, 10);
Â  Â  Â  Â  Â  rect(90, -80, 60, 60 - intensity*20, 10);

Â  Â  Â  Â  Â  // Celles molt inclinades
Â  Â  Â  Â  Â  stroke(80, 0, 0);
Â  Â  Â  Â  Â  strokeWeight(10 + intensity*4);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-140, -120);
Â  Â  Â  Â  Â  vertex(-90, -135 - intensity*25);
Â  Â  Â  Â  Â  endShape();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(140, -120);
Â  Â  Â  Â  Â  vertex(90, -135 - intensity*25);
Â  Â  Â  Â  Â  endShape();

Â  Â  Â  Â  Â  // Boca enfadada
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5 + intensity*3);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-80, 120);
Â  Â  Â  Â  Â  bezierVertex(-20, 100 - intensity*30, 20, 100 - intensity*30, 80, 120);
Â  Â  Â  Â  Â  endShape();

Â  Â  Â  Â  Â  // Galtes vermelles
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  fill(255, 60, 60, 40+intensity*120);
Â  Â  Â  Â  Â  ellipse(-90, 40, 50, 20);
Â  Â  Â  Â  Â  ellipse(90, 40, 50, 20);
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'surprised':
Â  Â  Â  Â  Â  // Cara clara, boca 'O', ulls grans, celles molt altes
Â  Â  Â  Â  Â  stroke(0, 0, 200, 150);
Â  Â  Â  Â  Â  fill(180+intensity*50, 180+intensity*50, 255);
Â  Â  Â  Â  Â  ellipse(0, 0, 400, 400);

Â  Â  Â  Â  Â  // Ulls molt oberts
Â  Â  Â  Â  Â  fill(255);
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(2);
Â  Â  Â  Â  Â  ellipse(-80, -40, 60+intensity*20, 60+intensity*20);
Â  Â  Â  Â  Â  ellipse(80, -40, 60+intensity*20, 60+intensity*20);

Â  Â  Â  Â  Â  // Pupiles grans
Â  Â  Â  Â  Â  fill(0);
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  ellipse(-80, -40, 20+intensity*10, 20+intensity*10);
Â  Â  Â  Â  Â  ellipse(80, -40, 20+intensity*10, 20+intensity*10);

Â  Â  Â  Â  Â  // Celles molt altes
Â  Â  Â  Â  Â  stroke(80,80,80);
Â  Â  Â  Â  Â  strokeWeight(8);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  arc(-80, -90-intensity*30, 80, 40+intensity*30, PI, TWO_PI);
Â  Â  Â  Â  Â  arc(80, -90-intensity*30, 80, 40+intensity*30, PI, TWO_PI);

Â  Â  Â  Â  Â  // Boca gran 'O'
Â  Â  Â  Â  Â  fill(0);
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  ellipse(0, 100, 60+intensity*30, 80+intensity*30);
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'disgusted':
Â  Â  Â  Â  Â  // Cara verda, boca torÃ§ada, celles arquejades, ulls semicerrats, nas arrugat
Â  Â  Â  Â  Â  stroke(100, 80, 0, 150);
Â  Â  Â  Â  Â  fill(180, 220, 100 - intensity*50, 220);
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-200,-200); vertex(200,-200); vertex(200,200); vertex(-200,200); vertex(-200,-200);
Â  Â  Â  Â  Â  endShape(CLOSE);

Â  Â  Â  Â  Â  // Ulls semicerrats
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5 + intensity*2);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  line(-140, -50, -90, -45-intensity*10);
Â  Â  Â  Â  Â  line(90, -45-intensity*10, 140, -50);

Â  Â  Â  Â  Â  // Celles arquejades
Â  Â  Â  Â  Â  stroke(80,50,0);
Â  Â  Â  Â  Â  strokeWeight(6);
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-150,-80);
Â  Â  Â  Â  Â  vertex(-120,-90-intensity*9);
Â  Â  Â  Â  Â  endShape();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(120,-90-intensity*9);
Â  Â  Â  Â  Â  vertex(150,-80);
Â  Â  Â  Â  Â  endShape();

Â  Â  Â  Â  Â  // Nas arrugat
Â  Â  Â  Â  Â  stroke(120, 100, 0);
Â  Â  Â  Â  Â  strokeWeight(3+intensity*2);
Â  Â  Â  Â  Â  line(-30, 70, -10, 65-intensity*6);
Â  Â  Â  Â  Â  line(10, 65-intensity*6, 30, 70);

Â  Â  Â  Â  Â  // Boca torÃ§ada
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5 + intensity*3);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  beginShape();
Â  Â  Â  Â  Â  vertex(-80, 120);
Â  Â  Â  Â  Â  bezierVertex(-30, 110-intensity*20, 20, 150+intensity*30, 80, 110-intensity*20);
Â  Â  Â  Â  Â  endShape();

Â  Â  Â  Â  Â  // Sota la boca, verd per nÃ usea
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  fill(90, 200, 90, 70+intensity*100);
Â  Â  Â  Â  Â  ellipse(0, 160, 120+intensity*50, 40+intensity*20);
Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  // Cara neutra, boca recta, celles rectes, ulls simples
Â  Â  Â  Â  Â  stroke(100,100,100,150);
Â  Â  Â  Â  Â  fill(200, 200, 200, 200);
Â  Â  Â  Â  Â  ellipse(0, 0, 400, 400);

Â  Â  Â  Â  Â  // Ulls simples
Â  Â  Â  Â  Â  fill(0);
Â  Â  Â  Â  Â  noStroke();
Â  Â  Â  Â  Â  ellipse(-80, -40, 30, 30);
Â  Â  Â  Â  Â  ellipse(80, -40, 30, 30);

Â  Â  Â  Â  Â  // Celles rectes
Â  Â  Â  Â  Â  stroke(60);
Â  Â  Â  Â  Â  strokeWeight(4);
Â  Â  Â  Â  Â  line(-110, -80, -50, -80);
Â  Â  Â  Â  Â  line(50, -80, 110, -80);

Â  Â  Â  Â  Â  // Boca recta
Â  Â  Â  Â  Â  stroke(0);
Â  Â  Â  Â  Â  strokeWeight(5);
Â  Â  Â  Â  Â  noFill();
Â  Â  Â  Â  Â  line(-80, 100, 80, 100);
Â  Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }

Â  Â  // FUNCIÃ“ drawHUD
Â  Â  function drawHUD() {
Â  Â  Â  // Aquesta funciÃ³ dibuixa el Heads-Up Display que mostra un emoticon i el percentatge d'intensitat.
Â  Â  Â  const traduccions = {
Â  Â  Â  Â  happy: "ðŸ˜ƒ FeliÃ§",
Â  Â  Â  Â  sad: "ðŸ˜¢ Trist",
Â  Â  Â  Â  angry: "ðŸ˜¡ Enfadat",
Â  Â  Â  Â  surprised: "ðŸ˜² SorprÃ¨s",
Â  Â  Â  Â  disgusted: "ðŸ¤¢ Fastiguejat",
Â  Â  Â  Â  neutral: "ðŸ˜ Neutral",
Â  Â  Â  Â  fearful: "ðŸ˜¨ Espantat"
Â  Â  Â  };
Â  Â  Â  const emoticon = traduccions[currentExpression.dominant] || "ðŸ˜ Neutral";
Â  Â  Â  noStroke();
Â  Â  Â  fill(50, 150, 255);
Â  Â  Â  textSize(map(width, 500, 1200, 16, 24)); // la mida del text s'ajusta
Â  Â  Â  textAlign(CENTER, TOP);
Â  Â  Â  text(`${emoticon} (${floor(smoothIntensity * 100)}%)`, width / 2, 20);
Â  Â  }

Â  Â  // FUNCIÃ“ drawVideoPreview
Â  Â  function drawVideoPreview() {
Â  Â  Â  // Aquesta funciÃ³ dibuixa una petita previsualitzaciÃ³ del vÃ­deo de la cÃ mera a la cantonada inferior dreta.
Â  Â  Â  const previewSize = min(width, height) * 0.15;
Â  Â  Â  image(
Â  Â  Â  Â  video,
Â  Â  Â  Â  width - previewSize - 10,
Â  Â  Â  Â  height - previewSize - 10,
Â  Â  Â  Â  previewSize,
Â  Â  Â  Â  previewSize
Â  Â  Â  );
Â  Â  }

Â  Â  // GESTIÃ“ D'ERRORS AMB LA CÃ€MERA
Â  Â  // Demana accÃ©s a la cÃ mera del dispositiu.
Â  Â  navigator.mediaDevices.getUserMedia({ video: true })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  document.getElementById('loading-screen').innerHTML = `
Â  Â  Â  Â  Â  <p style="color: red; text-align: center">
Â  Â  Â  Â  Â  Â  Error de cÃ mera!<br>
Â  Â  Â  Â  Â  Â  Permet l'accÃ©s a la cÃ mera i actualitza.
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  `;
Â  Â  Â  });
Â  </script>
</body>
</html>
