<!DOCTYPE html>
<html lang="ca">
<!--
  Gat Expressiu Klee PICTÒRIC - Emocions i fidelitat al quadre original de Klee
  - Ulls gegants i ametllats, pupil·la verda vertical, contorn negre pictòric, cejas pictòriques.
  - Nas de cor vermell.
  - Boca simple corbada i "M" de gat.
  - Bigotis difusos i llargs.
  - Ocell pictòric sobre el nas.
  - Colors, degradats i textures pictòriques.
  - Expressió facial ML5.js.
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gat Expressiu Klee Pictòric</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #222;}
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial, sans-serif; z-index: 1000;
    }
    .loader {
      width: 40px; height: 40px;
      border: 5px solid #3498db; border-top-color: transparent;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-screen p { margin-top: 15px; font-size: 1.1em; color: #333; }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="loader"></div>
    <p>Carregant models...</p>
  </div>
  <script>
    // === VARIABLES GLOBALS I PALETA PICTÒRICA ===
    let faceapi, detections = [], video;
    let modelsReady = false;
    let currentExpression = { dominant: 'neutral', intensity: 0 };
    let smoothIntensity = 0;
    let currentGradientStart, currentGradientEnd;
    let targetGradientStart, targetGradientEnd;

    // Paleta pictòrica inspirada en el quadre real
    const PALETTE = {
      ochre: [224,185,124],
      orange: [216,131,40],
      red: [210,37,57],
      rose: [241,125,157],
      brown: [110, 60, 30],
      cream: [252,227,181],
      black: [18,14,12],
      greenEye: [74, 156, 90],
      greenDeep: [47, 102, 40],
      birdRed: [255, 98, 140],
      birdWing: [200, 80, 110]
    };

    function getGradientForEmotion(emotion) {
      // Tots els gradients pictòrics, però molt suaus per mantenir l'atmosfera Klee
      switch (emotion) {
        case 'happy':
          return { start: color(255, 228, 181), end: color(255, 183, 107) };
        case 'sad':
          return { start: color(178, 210, 250), end: color(120, 160, 210) };
        case 'angry':
          return { start: color(255, 160, 122), end: color(180, 60, 40) };
        case 'disgusted':
          return { start: color(189, 210, 156), end: color(153, 180, 90) };
        case 'surprised':
          return { start: color(255, 240, 210), end: color(205, 155, 205) };
        case 'fearful':
          return { start: color(240, 235, 230), end: color(110, 120, 140) };
        default:
          return { start: color(224,185,124), end: color(210,140,55) };
      }
    }

    function setGradient(x, y, w, h, c1, c2, axis = 'y') {
      noFill();
      if (axis === 'y') {
        for (let i = y; i <= y + h; i++) {
          let inter = map(i, y, y + h, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(x, i, x + w, i);
        }
      } else if (axis === 'x') {
        for (let i = x; i <= x + w; i++) {
          let inter = map(i, x, x + w, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(i, y, i, y + h);
        }
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      let neutralGrad = getGradientForEmotion('neutral');
      currentGradientStart = neutralGrad.start;
      currentGradientEnd = neutralGrad.end;
      video = createCapture(VIDEO);
      video.size(320, 240);
      video.hide();
      video.elt.muted = true;
      video.elt.playsinline = true;
      const options = { withLandmarks: true, withExpressions: true, withDescriptors: false };
      faceapi = ml5.faceApi(video, options, () => {
        modelsReady = true;
        document.getElementById('loading-screen').style.display = 'none';
        faceapi.detect(gotResults);
      });
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      video.size(max(160, width / 4), max(120, height / 4));
    }

    function gotResults(err, results) {
      if (err) {
        console.error(err);
        document.getElementById('loading-screen').innerHTML =
          '<p style="color: red">Error! Comprova la càmera i actualitza.</p>';
        return;
      }
      detections = results;
      if (detections.length > 0) updateCurrentExpression();
      faceapi.detect(gotResults);
    }

    function updateCurrentExpression() {
      let maxIntensity = 0;
      detections.forEach(face => {
        const expr = face.expressions;
        const dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
        if (expr[dominant] > maxIntensity) {
          currentExpression = { dominant, intensity: expr[dominant] };
          maxIntensity = expr[dominant];
        }
      });
      let grad = getGradientForEmotion(currentExpression.dominant);
      targetGradientStart = grad.start;
      targetGradientEnd = grad.end;
    }

    function draw() {
      smoothIntensity = lerp(smoothIntensity, currentExpression.intensity, 0.13);
      if (targetGradientStart && targetGradientEnd) {
        currentGradientStart = lerpColor(currentGradientStart, targetGradientStart, 0.13);
        currentGradientEnd = lerpColor(currentGradientEnd, targetGradientEnd, 0.13);
      }
      drawKleeBackground();
      push();
      translate(width / 2, height / 2 + 20);
      scale(Math.min(width, height) / 900);
      drawKleeCatFace(currentExpression.dominant, smoothIntensity);
      pop();
      drawHUD();
      drawVideoPreview();
    }

    // === Fons pictòric i taques inspirades en Klee ===
    function drawKleeBackground() {
      for(let y=0; y<height; y+=2){
        let c = lerpColor(color(237, 186, 120), color(205, 98, 40), y/height);
        fill(redNoise(c.levels[0],y), redNoise(c.levels[1],y), redNoise(c.levels[2],y), 230);
        rect(0, y, width, 2);
      }
      fill(220,120,60,16); ellipse(width*0.18,height*0.55,220,260);
      fill(255,140,120,16); ellipse(width*0.72,height*0.22,280,180);
      fill(240,180,110,12); ellipse(width*0.68,height*0.8,300,120);
    }
    function redNoise(val, y) { return val + noise(y/160.0)*15-7; }

    // === Dibuixa el GAT de Klee amb emoció i fidelitat pictòrica ===
    function drawKleeCatFace(expr, inten) {
      // Cap gran
      noStroke();
      fill(...PALETTE.ochre, 238);
      ellipse(0, 60, 630, 540);

      // Ulls gegants
      let eyeY = -45, eyeLen = 435, eyeTall = 145;
      for(let i=-1;i<=1;i+=2) {
        push();
        translate(i*eyeLen*0.23, eyeY);
        rotate(radians(i*2));
        // Ombra pictòrica
        fill(211,110,40,24); ellipse(0, 5, eyeLen*1.03, eyeTall*1.13);
        // Ull blanc amb tons ocres
        fill(250,236,200,210);
        stroke(42,30,16, 120); strokeWeight(10);
        beginShape();
        for(let t=0;t<=1.001;t+=0.02){
          let x=lerp(-eyeLen/2,eyeLen/2,t);
          let y=sin(t*PI)*eyeTall/2;
          vertex(x,y);
        }
        for(let t=1;t>=-0.001;t-=0.02){
          let x=lerp(eyeLen/2,-eyeLen/2,t);
          let y=-sin(t*PI)*eyeTall*0.46;
          vertex(x,y);
        }
        endShape(CLOSE);
        // Pupila verda vertical
        fill(...PALETTE.greenEye, 220);
        noStroke();
        ellipse(0,0,41,eyeTall*0.93);
        fill(...PALETTE.greenDeep,230);
        ellipse(0,0,19,eyeTall*0.93);
        fill(255,255,255,38); ellipse(-10,-18,13,23);
        pop();
      }

      // "Cejas"/arcs pictòrics a sobre dels ulls
      stroke(...PALETTE.black,175); strokeWeight(17);
      noFill();
      arc(-eyeLen*0.23, eyeY-34, 220, 87, radians(178), radians(360-18));
      arc(eyeLen*0.23, eyeY-34, 220, 87, radians(198), radians(360));

      // Ocell pictòric sobre el nas
      drawKleeBird(0, eyeY-38, 120, 55);

      // Nas de cor vermell
      drawHeartNose(0, 89, 60, 56);

      // Boca simple i "M" pictòrica sota el nas (emoció: només canvia lleument la corba)
      stroke(...PALETTE.black, 200); strokeWeight(8);
      noFill();
      beginShape();
      if (expr === "happy") {
        vertex(-43, 170);
        bezierVertex(-15, 180, 15, 180, 43, 170);
      } else if (expr === "sad") {
        vertex(-43, 175);
        bezierVertex(-15, 215, 15, 215, 43, 175);
      } else if (expr === "angry") {
        vertex(-43, 170);
        bezierVertex(-20, 190, 20, 190, 43, 170);
      } else {
        vertex(-43, 170);
        bezierVertex(-15, 203, 15, 203, 43, 170);
      }
      endShape();

      // "M" felina pictòrica sota el nas
      stroke(...PALETTE.black, 100); strokeWeight(8);
      noFill();
      beginShape();
      vertex(-24, 122); bezierVertex(-42,162, -71,162, -126, 154);
      endShape();
      beginShape();
      vertex(24, 122); bezierVertex(42,162, 71,162, 126, 154);
      endShape();

      // Bigotis pictòrics llargs i difusos
      for(let side of [-1,1]) for(let w=0;w<3;w++){
        let y0=168+w*16, y1=165+w*6, spread=280+55*w;
        stroke(72,50,33, 120-30*w); strokeWeight(8-2*w);
        line(side*28, y0, side*spread, y1+random(-2,2));
      }
    }

    // Nas de cor pictòric
    function drawHeartNose(x, y, w, h) {
      push();
      translate(x, y);
      scale(w/100, h/100);
      fill(...PALETTE.red,242);
      stroke(120,30,40,180); strokeWeight(7);
      beginShape();
      vertex(0, 20);
      bezierVertex(50, -40, 50, 60, 0, 100);
      bezierVertex(-50, 60, -50, -40, 0, 20);
      endShape(CLOSE);
      pop();
    }

    // Ocell pictòric fidel al quadre de Klee
    function drawKleeBird(x, y, w, h) {
      push();
      translate(x, y);
      scale(w/90, h/50);
      fill(...PALETTE.birdRed, 168); stroke(...PALETTE.birdWing, 170); strokeWeight(6);
      beginShape();
      vertex(-14,-5);
      bezierVertex(9,-27,36,-7,29,19);
      bezierVertex(12,27,-18,22,-14,-5);
      endShape(CLOSE);
      fill(...PALETTE.birdWing,170); noStroke();
      beginShape();
      vertex(5,9); bezierVertex(19,3,17,17,6,18); endShape(CLOSE);
      fill(...PALETTE.birdRed, 220);
      ellipse(21,-7,20,17);
      fill(230,200,90,180); triangle(37,-5,41,1,29,-1);
      fill(40,0,0,220); ellipse(27,-9,3,3);
      pop();
    }

    // HUD i previsualització vídeo
    function drawHUD() {
      const traduccions = {
        happy: "😄 Feliç",
        sad: "😭 Trist",
        angry: "😡 Enfadat",
        surprised: "😲 Sorprès",
        disgusted: "🤢 Fastiguejat",
        neutral: "😐 Neutral",
        fearful: "😨 Espantat"
      };
      const emoticon = traduccions[currentExpression.dominant] || "😐 Neutral";
      noStroke();
      fill(50, 150, 255);
      textSize(map(width, 500, 1200, 19, 29));
      textAlign(CENTER, TOP);
      text(`${emoticon} (${floor(smoothIntensity * 100)}%)`, width / 2, 20);
    }

    function drawVideoPreview() {
      const previewSize = min(width, height) * 0.13;
      image(
        video,
        width - previewSize - 10,
        height - previewSize - 10,
        previewSize,
        previewSize
      );
    }

    // Favicon per evitar error 404
    let link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/png';
    link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABe0lEQVQ4T6XTsUoDQRQG4M8TV1DUQbY2/gKroN5AewkILnU1wC+gSUgJQhBEGJ2FZ9wB2gseK0tXbKSa4h5nA+8z8zm7n7wqVJ9zHj9l8W8eS4Q5LhFVZkh1dqj9gHkB7oG2gH3MUskZtQthvKc5ELJGbU4Y7p9wCkAcf7kY0Gz6ZxkQvYcK3VQdA+Sn0shPqv1Bu0n8sW3gKc8ho2d2IN8nJ1lLZpI1eL1pQ9M6nU2fP8pA7h0rCHGczJ2QJ8nPpVf7jQK2xD/HQ2xKq7w8NQ7xkIb5F+F2zQe7ZLXQAAAABJRU5ErkJggg==';
    document.head.appendChild(link);

    navigator.mediaDevices.getUserMedia({ video: true })
      .catch(err => {
        document.getElementById('loading-screen').innerHTML = `
          <p style="color: red; text-align: center">
            Error de càmera!<br>
            Permet l'accés a la càmera i actualitza.
          </p>
        `;
      });
  </script>
</body>
</html>
