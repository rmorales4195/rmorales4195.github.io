<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gat i Ocell Klee - Art Facial Emocional FIDEL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #222; }
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial, sans-serif; z-index: 1000;
    }
    .loader {
      width: 40px; height: 40px;
      border: 5px solid #e25d34; border-top-color: transparent;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-screen p { margin-top: 15px; font-size: 1.1em; color: #aa4400; }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="loader"></div>
    <p>Carregant models...</p>
  </div>
  <script>
    // ML5 globals and palette
    let faceapi, detections = [], video;
    let modelsReady = false;
    let currentExpression = { dominant: 'neutral', intensity: 0 };
    let smoothIntensity = 0;

    // Dynamic background
    let currentGradientStart, currentGradientEnd;
    let targetGradientStart, targetGradientEnd;

    // Palette inspired by Klee
    const PALETTE = {
      ochre: [224,185,124],
      orange: [220,122,40],
      red: [210,37,57],
      rose: [241,125,157],
      cream: [252,227,181],
      black: [18,14,12],
      greenEye: [74, 156, 90],
      greenDeep: [47, 102, 40],
      birdRed: [255, 98, 140],
      birdWing: [200, 80, 110]
    };

    function getGradientForEmotion(emotion) {
      switch (emotion) {
        case 'happy':
          return { start: color(255, 223, 186), end: color(255, 183, 77) };
        case 'sad':
          return { start: color(173, 216, 230), end: color(100, 149, 237) };
        case 'angry':
          return { start: color(255, 160, 122), end: color(255, 69, 0) };
        case 'disgusted':
          return { start: color(144, 238, 144), end: color(34, 139, 34) };
        case 'surprised':
          return { start: color(216, 191, 216), end: color(147, 112, 219) };
        default:
          return { start: color(240, 240, 240), end: color(200, 200, 200) };
      }
    }

    function setGradient(x, y, w, h, c1, c2, axis = 'y') {
      noFill();
      if (axis === 'y') {
        for (let i = y; i <= y + h; i++) {
          let inter = map(i, y, y + h, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(x, i, x + w, i);
        }
      } else if (axis === 'x') {
        for (let i = x; i <= x + w; i++) {
          let inter = map(i, x, x + w, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(i, y, i, y + h);
        }
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      let neutralGrad = getGradientForEmotion('neutral');
      currentGradientStart = neutralGrad.start;
      currentGradientEnd = neutralGrad.end;
      video = createCapture(VIDEO);
      video.size(320, 240);
      video.hide();
      video.elt.muted = true;
      video.elt.playsinline = true;
      const options = { withLandmarks: true, withExpressions: true, withDescriptors: false };
      faceapi = ml5.faceApi(video, options, () => {
        modelsReady = true;
        document.getElementById('loading-screen').style.display = 'none';
        faceapi.detect(gotResults);
      });
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      video.size(max(160, width / 4), max(120, height / 4));
    }

    function gotResults(err, results) {
      if (err) {
        document.getElementById('loading-screen').innerHTML =
          '<p style="color: red">Error! Comprova la càmera i actualitza.</p>';
        return;
      }
      detections = results;
      if (detections.length > 0) updateCurrentExpression();
      faceapi.detect(gotResults);
    }

    function updateCurrentExpression() {
      let maxIntensity = 0;
      detections.forEach(face => {
        const expr = face.expressions;
        const dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
        if (expr[dominant] > maxIntensity) {
          currentExpression = { dominant, intensity: expr[dominant] };
          maxIntensity = expr[dominant];
        }
      });
      let grad = getGradientForEmotion(currentExpression.dominant);
      targetGradientStart = grad.start;
      targetGradientEnd = grad.end;
    }

    function draw() {
      smoothIntensity = lerp(smoothIntensity, currentExpression.intensity, 0.1);
      if (targetGradientStart && targetGradientEnd) {
        currentGradientStart = lerpColor(currentGradientStart, targetGradientStart, 0.1);
        currentGradientEnd = lerpColor(currentGradientEnd, targetGradientEnd, 0.1);
      }
      setGradient(0, 0, width, height, currentGradientStart, currentGradientEnd, 'y');
      push();
      translate(width / 2, height / 2 + 10);
      scale(min(width, height) / 900);
      drawKleeCatFace(currentExpression.dominant, smoothIntensity);
      pop();
      drawHUD();
      drawVideoPreview();
    }

    // --- CAT FACE FIEL AL CUADRO DE KLEE ---
    function drawKleeCatFace(expr, inten) {
      drawKleeFaceBase();
      drawKleeEyes();
      drawKleeBird();
      drawKleeNose();
      drawKleeMouth(expr, inten);
      drawKleeWhiskers();
      drawKleeExtraDetails();
    }

    function drawKleeFaceBase() {
      rectMode(CENTER);
      noStroke();
      fill(...PALETTE.ochre, 238);
      rect(0, 60, 690, 540, 120, 120, 180, 180);
      fill(210,130,60,22); ellipse(-180,120,190,110);
      fill(210,130,60,15); ellipse(200,180,270,120);
      fill(180,90,23,8); ellipse(0,130,590,140);
    }

    // --- OJOS FIJOS, ALMENDRADOS, DENTRO DE LA CARA ---
    function drawKleeEyes() {
      let eyeY = -30, eyeLen = 350, eyeTall = 98;
      let offsetX = 187;
      for(let i=-1;i<=1;i+=2) {
        let eyeX = i*offsetX;
        push();
        translate(eyeX, eyeY);
        fill(250,236,200,215);
        stroke(42,30,16, 120); strokeWeight(8);
        beginShape();
        vertex(-eyeLen/2, 0);
        vertex(eyeLen/2, 0);
        bezierVertex(eyeLen/2, eyeTall/1.85, -eyeLen/2, eyeTall/1.85, -eyeLen/2, 0);
        endShape(CLOSE);

        // Pupila verda vertical, centrada (ligeramente hacia dentro)
        fill(...PALETTE.greenEye, 220); noStroke();
        ellipse(-12*i,eyeTall*0.18,32,eyeTall*0.9);
        fill(...PALETTE.greenDeep,230);
        ellipse(-12*i,eyeTall*0.18,10,eyeTall*0.9);

        // Difuminat pictòric interior
        for(let k=0;k<10;k++){
          fill(90,80,30,7);
          ellipse(-12*i,eyeTall/6,eyeLen*0.64-k*12,eyeTall*0.36-k*4);
        }
        pop();
      }
    }

    // --- PAJARO ROSA CENTRAL: MUY GRANDE Y VISIBLE ---
    function drawKleeBird() {
      let x = 0, y = -65, w = 350, h = 175;
      push();
      translate(x, y);
      scale(w/90, h/50);

      // Cuerpo grande
      fill(...PALETTE.birdRed, 200); stroke(...PALETTE.birdWing, 170); strokeWeight(16);
      beginShape();
      vertex(-22,-7);
      bezierVertex(33,-90,110,-19,78,52);
      bezierVertex(36,120,-40,65,-22,-7);
      endShape(CLOSE);

      // Ala amplia
      fill(...PALETTE.birdWing,120); noStroke();
      beginShape();
      vertex(20,35); bezierVertex(105,10,74,102,22,78); endShape(CLOSE);

      // Cabeza
      fill(...PALETTE.birdRed, 235);
      ellipse(65,-21,48,38);

      // Pico
      fill(230,200,90,220); triangle(118,-16,142,12,90,-7);

      // Ojo
      fill(40,0,0,210); ellipse(85,-26,9,9);

      pop();
    }

    // --- NARIZ DE COR ---
    function drawKleeNose() {
      let x = 0, y = 120, w = 90, h = 82;
      push();
      translate(x, y);
      scale(w/100, h/100);
      for(let i=0;i<22;i++){
        fill(210,37,57,13);
        beginShape();
        vertex(0, 20+random(-2,2));
        bezierVertex(50+random(-3,3), -40+random(-3,3), 50+random(-3,3), 60+random(-3,3), 0, 100+random(-3,3));
        bezierVertex(-50+random(-3,3), 60+random(-3,3), -50+random(-3,3), -40+random(-3,3), 0, 20+random(-2,2));
        endShape(CLOSE);
      }
      fill(210,37,57,220);
      beginShape();
      vertex(0, 20);
      bezierVertex(50, -40, 50, 60, 0, 100);
      bezierVertex(-50, 60, -50, -40, 0, 20);
      endShape(CLOSE);
      pop();
    }

    // --- BOCA Y "M" SEGÚN EMOCIÓN ---
    function drawKleeMouth(expr, inten) {
      let mouthY = 245, mouthW = 72;
      let smileOffset = 0;
      if(expr==="happy") smileOffset = 36*inten;
      if(expr==="sad") smileOffset = -28*inten;
      if(expr==="angry") smileOffset = -12*inten;
      stroke(...PALETTE.black, 170); strokeWeight(7.5);
      noFill();
      beginShape();
      vertex(-mouthW, mouthY);
      bezierVertex(-12, 285+smileOffset, 12, 285+smileOffset, mouthW, mouthY);
      endShape();

      // "M" suau sota el nas
      stroke(...PALETTE.black, 65); strokeWeight(7);
      noFill();
      beginShape();
      vertex(-31, 174); bezierVertex(-57,230, -99,230, -185, 207);
      endShape();
      beginShape();
      vertex(31, 174); bezierVertex(57,230, 99,230, 185, 207);
      endShape();
    }

    // --- BIGOTES ---
    function drawKleeWhiskers() {
      let whiskerBaseY = 185;
      for(let side of [-1,1]) for(let w=0;w<3;w++){
        let y0=whiskerBaseY+w*13, y1=whiskerBaseY-2+w*7, spread=270+40*w;
        stroke(72,50,33, 110-28*w); strokeWeight(6-1.3*w);
        line(side*54, y0, side*spread, y1+random(-2,2));
      }
    }

    // --- DETALLES PICTÓRICOS EXTRA ---
    function drawKleeExtraDetails() {
      fill(160,80,50,13); ellipse(0, 325, 180, 25);
      fill(160,80,50,8); ellipse(-260, 170, 90, 120);
      fill(210,37,57,7); ellipse(0,180,350,60);
    }

    // --- HUD Y VÍDEO ---
    function drawHUD() {
      const traduccions = {
        happy: "😄 Feliç",
        sad: "😭 Trist",
        angry: "😡 Enfadat",
        surprised: "😲 Sorprès",
        disgusted: "🤢 Fastiguejat",
        neutral: "😐 Neutral",
        fearful: "😨 Espantat"
      };
      const emoticon = traduccions[currentExpression.dominant] || "😐 Neutral";
      noStroke();
      fill(50, 150, 255);
      textSize(map(width, 500, 1200, 19, 29));
      textAlign(CENTER, TOP);
      text(`${emoticon} (${floor(smoothIntensity * 100)}%)`, width / 2, 20);
    }

    function drawVideoPreview() {
      const previewSize = min(width, height) * 0.13;
      image(
        video,
        width - previewSize - 10,
        height - previewSize - 10,
        previewSize,
        previewSize
      );
    }

    // Favicon y seguridad
    let link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/png';
    link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABe0lEQVQ4T6XTsUoDQRQG4M8TV1DUQbY2/gKroN5AewkILnU1wC+gSUgJQhBEGJ2FZ9wB2gseK0tXbKSa4h5nA+8z8zm7n7wqVJ9zHj9l8W8eS4Q5LhFVZkh1dqj9gHkB7oG2gH3MUskZtQthvKc5ELJGbU4Y7p9wCkAcf7kY0Gz6ZxkQvYcK3VQdA+Sn0shPqv1Bu0n8sW3gKc8ho2d2IN8nJ1lLZpI1eL1pQ9M6nU2fP8pA7h0rCHGczJ2QJ8nPpVf7jQK2xD/HQ2xKq7w8NQ7xkIb5F+F2zQe7ZLXQAAAABJRU5ErkJggg==';
    document.head.appendChild(link);

    navigator.mediaDevices.getUserMedia({ video: true })
      .catch(err => {
        document.getElementById('loading-screen').innerHTML = `
          <p style="color: red; text-align: center">
            Error de càmera!<br>
            Permet l'accés a la càmera i actualitza.
          </p>
        `;
      });
  </script>
</body>
</html>
