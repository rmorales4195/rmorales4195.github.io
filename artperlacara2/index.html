<!DOCTYPE html>
<html lang="ca">
<!--
  Animació interactiva inspirada en "Gato y Pájaro" de Paul Klee (![image1](image1)).
  El rostre del gat reacciona expressivament a les emocions facials reals capturades per la càmera:
  - happy, sad, angry, surprised, disgusted, fearful, neutral.
  Boca, ulls, bigotis i el petit ocell canvien d'acord amb l'emoció, sempre dins de l'estètica pictòrica original.
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gat Expressiu Klee - Art Facial Realista</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #222; }
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: Arial, sans-serif; z-index: 1000;
    }
    .loader {
      width: 40px; height: 40px;
      border: 5px solid #3498db; border-top-color: transparent;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-screen p { margin-top: 15px; font-size: 1.1em; color: #333; }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="loader"></div>
    <p>Carregant models...</p>
  </div>
  <script>
    // === CONFIGURACIÓ I DADES ===
    let faceapi, detections = [], video;
    let modelsReady = false;
    let currentExpression = { dominant: 'neutral', intensity: 0 };
    let smoothIntensity = 0;
    let currentGradientStart, currentGradientEnd;
    let targetGradientStart, targetGradientEnd;

    // Paleta pictòrica basada en el quadre de Klee
    const PALETTE = {
      base: [224,196,124], // fons cremós
      orange: [216, 131, 40],
      ochre: [210, 140, 55],
      red:   [210, 37, 57],
      rose:  [241, 125, 157],
      light: [252, 227, 181],
      shadow: [110, 60, 30],
      eyeWhite: [249, 243, 215],
      eyeGreen: [78, 143, 94],
      nose: [220, 73, 80],
      whisker: [96, 80, 70]
    };

    // Gradient de fons suau segons emoció
    function getGradientForEmotion(emotion) {
      switch (emotion) {
        case 'happy':
          return { start: color(252,227,181), end: color(255, 183, 77) };
        case 'sad':
          return { start: color(178, 210, 230), end: color(120, 160, 210) };
        case 'angry':
          return { start: color(255, 160, 122), end: color(170, 60, 30) };
        case 'disgusted':
          return { start: color(189, 210, 156), end: color(153, 180, 90) };
        case 'surprised':
          return { start: color(255, 240, 210), end: color(205, 155, 205) };
        case 'fearful':
          return { start: color(240, 225, 200), end: color(110, 120, 140) };
        default:
          return { start: color(224,196,124), end: color(210,140,55) };
      }
    }

    function setGradient(x, y, w, h, c1, c2, axis = 'y') {
      noFill();
      if (axis === 'y') {
        for (let i = y; i <= y + h; i++) {
          let inter = map(i, y, y + h, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(x, i, x + w, i);
        }
      } else if (axis === 'x') {
        for (let i = x; i <= x + w; i++) {
          let inter = map(i, x, x + w, 0, 1);
          let c = lerpColor(c1, c2, inter);
          stroke(c);
          line(i, y, i, y + h);
        }
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      let neutralGrad = getGradientForEmotion('neutral');
      currentGradientStart = neutralGrad.start;
      currentGradientEnd = neutralGrad.end;
      video = createCapture(VIDEO);
      video.size(320, 240);
      video.hide();
      video.elt.muted = true;
      video.elt.playsinline = true;
      const options = { withLandmarks: true, withExpressions: true, withDescriptors: false };
      faceapi = ml5.faceApi(video, options, () => {
        modelsReady = true;
        document.getElementById('loading-screen').style.display = 'none';
        faceapi.detect(gotResults);
      });
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      video.size(max(160, width / 4), max(120, height / 4));
    }

    function gotResults(err, results) {
      if (err) {
        console.error(err);
        document.getElementById('loading-screen').innerHTML =
          '<p style="color: red">Error! Comprova la càmera i actualitza.</p>';
        return;
      }
      detections = results;
      if (detections.length > 0) updateCurrentExpression();
      faceapi.detect(gotResults);
    }

    function updateCurrentExpression() {
      let maxIntensity = 0;
      detections.forEach(face => {
        const expr = face.expressions;
        const dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
        if (expr[dominant] > maxIntensity) {
          currentExpression = { dominant, intensity: expr[dominant] };
          maxIntensity = expr[dominant];
        }
      });
      let grad = getGradientForEmotion(currentExpression.dominant);
      targetGradientStart = grad.start;
      targetGradientEnd = grad.end;
    }

    function draw() {
      smoothIntensity = lerp(smoothIntensity, currentExpression.intensity, 0.12);
      if (targetGradientStart && targetGradientEnd) {
        currentGradientStart = lerpColor(currentGradientStart, targetGradientStart, 0.10);
        currentGradientEnd = lerpColor(currentGradientEnd, targetGradientEnd, 0.10);
      }
      setGradient(0, 0, width, height, currentGradientStart, currentGradientEnd, 'y');
      push();
      translate(width / 2, height / 2);
      scale(Math.min(width, height) / 900);
      drawKleeCatFace(currentExpression.dominant, smoothIntensity);
      pop();
      drawHUD();
      drawVideoPreview();
    }

    // === Dibuix realista i expressiu ===
    function drawKleeCatFace(expr, inten) {
      // === Paràmetres base ===
      let s = 650, eyeW = 210, eyeH = 75, eyeY = -80;
      let eyeOpen = 1.0, eyeTilt = 0, eyeIrisW = 38, eyeIrisH = 54, eyeIrisColor = PALETTE.eyeGreen;
      let mouthSmile = 0, mouthFrown = 0, mouthWide = 0, mouthYmod = 0, mouthOpen = 0;
      let noseY = 90, noseH = 57, noseW = 38, noseCol = PALETTE.nose;
      let whiskerSpread = 1.0, whiskerAng = 0;
      let browLift = 0, browTilt = 0, browSad = 0;
      let birdColor = PALETTE.rose;

      // === Modificació segons emoció ===
      if(expr === 'happy') {
        eyeOpen = 1.12 + 0.18*inten;
        browLift = 8*inten; browTilt = 6*inten;
        mouthSmile = 1*inten; mouthYmod = -18*inten; mouthOpen = 16*inten;
        whiskerSpread = 1.18 + 0.07*inten;
        noseCol = [255, 110, 110];
        eyeIrisW = 46; eyeIrisColor = [98, 180, 94];
        birdColor = [255, 100, 180];
      } else if(expr === 'sad') {
        eyeOpen = 0.79 - 0.22*inten;
        browSad = 18*inten;
        mouthFrown = 1*inten; mouthYmod = 22*inten; mouthOpen = 10*inten;
        whiskerSpread = 0.93 - 0.06*inten;
        noseCol = [200, 90, 110];
        eyeIrisW = 36;
        birdColor = [190, 170, 230];
      } else if(expr === 'angry') {
        eyeTilt = -0.18*PI*inten; eyeOpen = 0.92 - 0.09*inten;
        browTilt = -13*inten;
        mouthFrown = 0.6*inten; mouthYmod = 5*inten; mouthOpen = 6*inten;
        whiskerSpread = 1.08 + 0.13*inten;
        noseCol = [255, 80, 80];
        eyeIrisColor = [60, 116, 86];
        birdColor = [200, 60, 60];
      } else if(expr === 'disgusted') {
        eyeTilt = 0.09*PI*inten; eyeOpen = 0.89 - 0.09*inten;
        mouthFrown = 0.7*inten; mouthSmile = 0.15*inten; mouthYmod = 10*inten; mouthOpen = 7*inten;
        whiskerSpread = 1.04;
        noseCol = [170, 160, 120];
        eyeIrisColor = [108, 174, 90];
        birdColor = [120, 200, 130];
      } else if(expr === 'surprised') {
        eyeOpen = 1.55 + 0.33*inten;
        browLift = 22*inten;
        mouthWide = 1*inten; mouthYmod = -10*inten; mouthOpen = 35*inten;
        whiskerSpread = 1.18 + 0.13*inten;
        eyeIrisW = 51;
        birdColor = [255, 180, 230];
      } else if(expr === 'fearful') {
        eyeOpen = 1.35 + 0.21*inten;
        browLift = 12*inten; browSad = 16*inten;
        mouthWide = 0.7*inten; mouthFrown = 0.5*inten; mouthYmod = 18*inten; mouthOpen = 27*inten;
        whiskerSpread = 1.01 - 0.03*inten;
        noseCol = [190, 180, 180];
        birdColor = [210, 210, 250];
      } else { // neutral
        eyeOpen = 1.06;
        whiskerSpread = 1.09;
      }

      // === Fons i forma base ===
      noStroke();
      fill(...PALETTE.base, 239);
      rectMode(CENTER); rect(0,0,s,s,68);

      // Ombres pictòriques suaus
      fill(...PALETTE.orange,47); rect(-s/4,0,s/2, s*0.7, 60);
      fill(...PALETTE.ochre,28); rect(s/4,s/6,s*0.38, s*0.43, 30);

      // === Ulls realistes, iris, reflexos ===
      push();
      for(let i=-1;i<=1;i+=2) {
        push();
        translate(i*180, eyeY);
        rotate(i*eyeTilt);
        // Blanc de l'ull
        fill(...PALETTE.eyeWhite, 240); stroke(120,90,50,45); strokeWeight(3);
        beginShape();
        for(let a=PI*0.18;a<PI*0.82;a+=0.05){
          let ex = cos(a)*eyeW/2, ey = sin(a)*eyeH/2*eyeOpen;
          vertex(ex,ey);
        }
        for(let a=PI*0.82;a>PI*0.18;a-=0.05){
          let ex = cos(a)*eyeW/2, ey = -sin(a)*eyeH/2*eyeOpen;
          vertex(ex,ey);
        }
        endShape(CLOSE);

        // Iris
        fill(...eyeIrisColor, 190);
        ellipse(0, 0, eyeIrisW, eyeIrisH*eyeOpen);
        fill(40, 80, 40, 180);
        ellipse(0, 0, eyeIrisW*0.45, eyeIrisH*eyeOpen*0.45);

        // Pupila vertical
        fill(20,70,20,210);
        beginShape();
        vertex(-6,-eyeH/2.8); vertex(0,-eyeH/1.5); vertex(6,-eyeH/2.8);
        vertex(8,eyeH/2.8); vertex(0,eyeH/1.09); vertex(-8,eyeH/2.8);
        endShape(CLOSE);

        // Reflexe
        fill(255,255,255,110);
        ellipse(-8,-eyeH/6.3, eyeIrisW*0.19, eyeIrisW*0.13);
        pop();
      }
      pop();

      // === Celles realistes (segons emoció) ===
      stroke(90,70,42,80); strokeWeight(11);
      line(-142, eyeY-25-browSad-browLift, -32, eyeY-45-browTilt+browLift);
      line(142, eyeY-25-browSad-browLift, 32, eyeY-45+browTilt+browLift);

      // === Ocell (bird) amb color i posició variables ===
      push();
      let birdY = -eyeH*1.6 + map(inten,0,1,-8,10);
      fill(...birdColor, 180);
      stroke(140,50,90,65);
      strokeWeight(2+5*inten);
      beginShape();
        vertex(-30, birdY-12);
        bezierVertex(-1, birdY-33, 38, birdY-19, 40, birdY+24);
        vertex(15, birdY+23);
        bezierVertex(2, birdY+37, -18, birdY+21, -30, birdY-12);
      endShape(CLOSE);
      // Cap i bec
      fill(...birdColor, 220);
      ellipse(37, birdY+8, 23,19);
      fill(220,180,90,180);
      triangle(48, birdY+8, 63, birdY+2, 48, birdY+12);
      strokeWeight(2);
      fill(40,0,0,220);
      ellipse(42, birdY+7, 4,4);
      pop();

      // === Nas realista ===
      fill(...noseCol, 235);
      stroke(200,60,70,80);
      strokeWeight(6);
      beginShape();
        vertex(-noseW/2, noseY);
        bezierVertex(-6, noseY+noseH/2, 6, noseY+noseH/2, noseW/2, noseY);
        vertex(0, noseY-8);
      endShape(CLOSE);

      // === Boca realista (animada amb beziers i obertura) ===
      noFill();
      stroke(130,50,60, 225);
      strokeWeight(8);
      beginShape();
        vertex(-45, noseY+30+mouthYmod);
        if (mouthSmile > 0.05) {
          bezierVertex(-18, noseY+60+mouthYmod, 18, noseY+60+mouthYmod+mouthOpen, 45, noseY+30+mouthYmod);
          bezierVertex(10, noseY+75+mouthYmod+mouthOpen, -10, noseY+75+mouthYmod+mouthOpen, -45, noseY+30+mouthYmod);
        } else if (mouthFrown > 0.05) {
          bezierVertex(-18, noseY+85+mouthYmod, 18, noseY+85+mouthYmod+mouthOpen, 45, noseY+30+mouthYmod);
          bezierVertex(0, noseY+135+mouthYmod+mouthOpen, 0, noseY+135+mouthYmod+mouthOpen, -45, noseY+30+mouthYmod);
        } else if (mouthWide > 0.05) {
          bezierVertex(-18, noseY+88+mouthYmod, 18, noseY+88+mouthYmod+mouthOpen*1.2, 45, noseY+30+mouthYmod);
          bezierVertex(20, noseY+110+mouthYmod+mouthOpen*1.2, -20, noseY+110+mouthYmod+mouthOpen*1.2, -45, noseY+30+mouthYmod);
        } else {
          bezierVertex(-18, noseY+75+mouthYmod, 18, noseY+75+mouthYmod, 45, noseY+30+mouthYmod);
        }
      endShape();

      // === Bigotis realistes ===
      stroke(...PALETTE.whisker, 110); strokeWeight(5);
      for(let i=-1;i<=1;i+=2) {
        let wx = i*70, wy = noseY+38;
        for(let k=0;k<3;++k) {
          let offsetY = [-16,18,-10][k], offsetYend = [-16,18+14,-36][k];
          let spread = [150,158,138][k] * whiskerSpread;
          line(wx, wy+offsetY, wx + i*spread, wy+offsetYend);
        }
      }
    }

    // HUD i previsualització vídeo
    function drawHUD() {
      const traduccions = {
        happy: "😃 Feliç",
        sad: "😢 Trist",
        angry: "😡 Enfadat",
        surprised: "😲 Sorprès",
        disgusted: "🤢 Fastiguejat",
        neutral: "😐 Neutral",
        fearful: "😨 Espantat"
      };
      const emoticon = traduccions[currentExpression.dominant] || "😐 Neutral";
      noStroke();
      fill(50, 150, 255);
      textSize(map(width, 500, 1200, 16, 24));
      textAlign(CENTER, TOP);
      text(`${emoticon} (${floor(smoothIntensity * 100)}%)`, width / 2, 20);
    }

    function drawVideoPreview() {
      const previewSize = min(width, height) * 0.15;
      image(
        video,
        width - previewSize - 10,
        height - previewSize - 10,
        previewSize,
        previewSize
      );
    }

    // Favicon (opcional per evitar error 404)
    let link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/png';
    link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABe0lEQVQ4T6XTsUoDQRQG4M8TV1DUQbY2/gKroN5AewkILnU1wC+gSUgJQhBEGJ2FZ9wB2gseK0tXbKSa4h5nA+8z8zm7n7wqVJ9zHj9l8W8eS4Q5LhFVZkh1dqj9gHkB7oG2gH3MUskZtQthvKc5ELJGbU4Y7p9wCkAcf7kY0Gz6ZxkQvYcK3VQdA+Sn0shPqv1Bu0n8sW3gKc8ho2d2IN8nJ1lLZpI1eL1pQ9M6nU2fP8pA7h0rCHGczJ2QJ8nPpVf7jQK2xD/HQ2xKq7w8NQ7xkIb5F+F2zQe7ZLXQAAAABJRU5ErkJggg==';
    document.head.appendChild(link);

    navigator.mediaDevices.getUserMedia({ video: true })
      .catch(err => {
        document.getElementById('loading-screen').innerHTML = `
          <p style="color: red; text-align: center">
            Error de càmera!<br>
            Permet l'accés a la càmera i actualitza.
          </p>
        `;
      });
  </script>
</body>
</html>
